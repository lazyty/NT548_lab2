name: 'NT548 - Terraform AWS Infrastructure Deploy'

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'terraform/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment Action'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy
      environment:
        description: 'Target Environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - production

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'
  TF_IN_AUTOMATION: true

jobs:
  checkov-security-scan:
    name: 'Checkov Security Scan'
    runs-on: ubuntu-latest
    outputs:
      security-passed: ${{ steps.checkov.outputs.security-passed }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Python for Checkov
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Checkov
      run: |
        pip install checkov==3.0.0
        checkov --version

    - name: Run Checkov Security Scan
      id: checkov
      run: |
        echo "Running Checkov security compliance scan..."
        
        # Run Checkov with multiple output formats
        checkov -d terraform/ \
          --framework terraform \
          --output cli \
          --output json \
          --output sarif \
          --output-file-path checkov-report \
          --soft-fail \
          --compact
        
        # Parse results and set outputs
        if [ -f "checkov-report.json" ]; then
          CRITICAL=$(jq -r '.results.failed_checks | map(select(.severity == "CRITICAL")) | length' checkov-report.json 2>/dev/null || echo "0")
          HIGH=$(jq -r '.results.failed_checks | map(select(.severity == "HIGH")) | length' checkov-report.json 2>/dev/null || echo "0")
          MEDIUM=$(jq -r '.results.failed_checks | map(select(.severity == "MEDIUM")) | length' checkov-report.json 2>/dev/null || echo "0")
          LOW=$(jq -r '.results.failed_checks | map(select(.severity == "LOW")) | length' checkov-report.json 2>/dev/null || echo "0")
          PASSED=$(jq -r '.results.passed_checks | length' checkov-report.json 2>/dev/null || echo "0")
          
          echo "critical-issues=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high-issues=$HIGH" >> $GITHUB_OUTPUT
          echo "medium-issues=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low-issues=$LOW" >> $GITHUB_OUTPUT
          echo "passed-checks=$PASSED" >> $GITHUB_OUTPUT
          
          # Determine if security scan passed (no critical/high issues)
          if [ "$CRITICAL" -eq 0 ] && [ "$HIGH" -eq 0 ]; then
            echo "security-passed=true" >> $GITHUB_OUTPUT
            echo "Security scan passed - No critical or high severity issues"
          else
            echo "security-passed=false" >> $GITHUB_OUTPUT
            echo "Security scan failed - Found $CRITICAL critical and $HIGH high severity issues"
          fi
        else
          echo "security-passed=false" >> $GITHUB_OUTPUT
          echo "Could not parse Checkov results"
        fi

    - name: Upload Checkov Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: checkov-security-report
        path: |
          checkov-report.json
          checkov-report.sarif
        retention-days: 30

    - name: Security Summary
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Critical | ${{ steps.checkov.outputs.critical-issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| High | ${{ steps.checkov.outputs.high-issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Medium | ${{ steps.checkov.outputs.medium-issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Low | ${{ steps.checkov.outputs.low-issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Passed | ${{ steps.checkov.outputs.passed-checks }} |" >> $GITHUB_STEP_SUMMARY

  terraform-plan-apply:
    name: 'Terraform Infrastructure'
    runs-on: ubuntu-latest
    needs: checkov-security-scan
    if: |
      (needs.checkov-security-scan.result == 'success' && github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch')
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    defaults:
      run:
        shell: bash
        working-directory: ./terraform

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Format Check
      run: |
        echo "Checking Terraform formatting..."
        terraform fmt -recursive
        echo "Terraform formatting completed"

    - name: Terraform Initialize
      run: |
        echo "Initializing Terraform..."
        terraform init -input=false
        echo "Terraform initialized successfully"

    - name: Terraform Validate
      run: |
        echo "Validating Terraform configuration..."
        terraform validate
        echo "Terraform configuration is valid"

    - name: Terraform Plan
      id: plan
      env:
        TF_VAR_allowed_ssh_ip: ${{ secrets.TF_VAR_allowed_ssh_ip }}
        TF_VAR_key_pair_name: ${{ secrets.TF_VAR_key_pair_name }}
      run: |
        echo "Creating Terraform execution plan..."
        terraform plan -input=false -no-color -out=tfplan
        
        # Show plan in readable format
        echo "plan-output<<EOF" >> $GITHUB_OUTPUT
        terraform show -no-color tfplan >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "Terraform plan completed"

    - name: Terraform Apply
      if: |
        (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
      env:
        TF_VAR_allowed_ssh_ip: ${{ secrets.TF_VAR_allowed_ssh_ip }}
        TF_VAR_key_pair_name: ${{ secrets.TF_VAR_key_pair_name }}
      run: |
        echo "Applying Terraform changes..."
        terraform apply -auto-approve tfplan
        echo "Infrastructure deployed successfully"

    - name: Install PowerShell for Destroy
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
      run: |
        wget -q https://github.com/PowerShell/PowerShell/releases/download/v7.3.8/powershell_7.3.8-1.deb_amd64.deb
        sudo dpkg -i powershell_7.3.8-1.deb_amd64.deb
        sudo apt-get install -f

    - name: Terraform Destroy
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
      working-directory: .
      run: |
        echo "Destroying infrastructure using PowerShell script..."
        pwsh -File scripts/destroy-infrastructure.ps1 -Force
        echo "Infrastructure destroyed successfully"

    - name: Save Terraform Outputs
      if: |
        (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
      run: |
        echo "Saving Terraform outputs..."
        terraform output -json > terraform-outputs.json
        echo "## Infrastructure Outputs" >> $GITHUB_STEP_SUMMARY
        echo '```json' >> $GITHUB_STEP_SUMMARY
        cat terraform-outputs.json >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload Terraform Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: terraform-artifacts
        path: |
          terraform/tfplan
          terraform/terraform-outputs.json
          terraform/terraform.tfstate
          terraform/terraform.tfstate.backup
        retention-days: 30

  infrastructure-tests:
    name: 'Infrastructure Testing'
    runs-on: ubuntu-latest
    needs: terraform-plan-apply
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Download Terraform Artifacts
      uses: actions/download-artifact@v4
      with:
        name: terraform-artifacts
        path: terraform/

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform for Tests
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Initialize Terraform for Testing
      working-directory: ./terraform
      run: terraform init -input=false

    - name: Install PowerShell
      run: |
        wget -q https://github.com/PowerShell/PowerShell/releases/download/v7.3.8/powershell_7.3.8-1.deb_amd64.deb
        sudo dpkg -i powershell_7.3.8-1.deb_amd64.deb
        sudo apt-get install -f

    - name: Run Infrastructure Tests
      working-directory: ./tests
      run: |
        echo "Running infrastructure validation tests..."
        pwsh -File run-tests.ps1
        echo "All infrastructure tests passed"

    - name: Run Connectivity Tests
      working-directory: ./tests
      run: |
        echo "Running connectivity tests..."
        pwsh -File test-connectivity.ps1
        echo "Connectivity tests completed"

  verify-destroy:
    name: 'Verify Infrastructure Destroyed'
    runs-on: ubuntu-latest
    needs: terraform-plan-apply
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Verify No NT548 Resources Exist
      run: |
        echo "Verifying all NT548 infrastructure has been destroyed..."
        
        # Check for VPCs
        VPC_COUNT=$(aws ec2 describe-vpcs --filters "Name=tag:Project,Values=NT548*" --query 'length(Vpcs)' --output text)
        echo "VPCs found: $VPC_COUNT"
        
        # Check for EC2 instances
        EC2_COUNT=$(aws ec2 describe-instances --filters "Name=tag:Project,Values=NT548*" "Name=instance-state-name,Values=running,stopped,stopping,pending" --query 'length(Reservations[].Instances[])' --output text)
        echo "EC2 instances found: $EC2_COUNT"
        
        # Check for NAT Gateways
        NAT_COUNT=$(aws ec2 describe-nat-gateways --filter "Name=tag:Project,Values=NT548*" "Name=state,Values=available,pending" --query 'length(NatGateways)' --output text)
        echo "NAT Gateways found: $NAT_COUNT"
        
        # Check for Elastic IPs
        EIP_COUNT=$(aws ec2 describe-addresses --filters "Name=tag:Project,Values=NT548*" --query 'length(Addresses)' --output text)
        echo "Elastic IPs found: $EIP_COUNT"
        
        # Summary
        TOTAL=$((VPC_COUNT + EC2_COUNT + NAT_COUNT + EIP_COUNT))
        
        echo ""
        echo "=== Destroy Verification Summary ==="
        if [ "$TOTAL" -eq 0 ]; then
          echo "SUCCESS: All NT548 infrastructure has been destroyed"
          echo "No resources found in AWS"
        else
          echo "FAILED: $TOTAL resources still exist"
          echo "VPCs: $VPC_COUNT"
          echo "EC2: $EC2_COUNT"
          echo "NAT Gateways: $NAT_COUNT"
          echo "Elastic IPs: $EIP_COUNT"
          exit 1
        fi

  deployment-notification:
    name: 'Deployment Notification'
    runs-on: ubuntu-latest
    needs: [checkov-security-scan, terraform-plan-apply, infrastructure-tests, verify-destroy]
    if: always()
    
    steps:
    - name: Deployment Success Notification
      if: |
        needs.checkov-security-scan.result == 'success' &&
        needs.terraform-plan-apply.result == 'success' &&
        (needs.infrastructure-tests.result == 'success' || needs.infrastructure-tests.result == 'skipped')
      run: |
        echo "## NT548 Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Security Scan**: Passed" >> $GITHUB_STEP_SUMMARY
        echo "**Infrastructure**: Deployed" >> $GITHUB_STEP_SUMMARY
        echo "**Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your AWS infrastructure is ready!" >> $GITHUB_STEP_SUMMARY

    - name: Destroy Success Notification
      if: |
        needs.terraform-plan-apply.result == 'success' &&
        needs.verify-destroy.result == 'success'
      run: |
        echo "## NT548 Infrastructure Destroyed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Terraform Destroy**: Success" >> $GITHUB_STEP_SUMMARY
        echo "**Verification**: All resources removed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "AWS infrastructure has been completely destroyed!" >> $GITHUB_STEP_SUMMARY

    - name: Deployment Failure Notification
      if: |
        needs.checkov-security-scan.result == 'failure' ||
        needs.terraform-plan-apply.result == 'failure' ||
        needs.infrastructure-tests.result == 'failure' ||
        needs.verify-destroy.result == 'failure'
      run: |
        echo "## NT548 Workflow Failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Security Scan**: ${{ needs.checkov-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Infrastructure**: ${{ needs.terraform-plan-apply.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tests**: ${{ needs.infrastructure-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Destroy Verification**: ${{ needs.verify-destroy.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs and fix the issues." >> $GITHUB_STEP_SUMMARY
        exit 1