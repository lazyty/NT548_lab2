name: 'NT548 - Terraform AWS Infrastructure Deploy'

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'terraform/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment Action'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy
        - destroy-all
        - destroy-everything
      environment:
        description: 'Target Environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - production

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'
  TF_IN_AUTOMATION: true

jobs:
  checkov-security-scan:
    name: 'Checkov Security Scan'
    runs-on: ubuntu-latest
    outputs:
      security-passed: ${{ steps.checkov.outputs.security-passed }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Python for Checkov
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Checkov
      run: |
        pip install checkov==3.0.0
        checkov --version

    - name: Run Checkov Security Scan
      id: checkov
      run: |
        echo "Running Checkov security compliance scan..."
        
        # Run Checkov with multiple output formats
        checkov -d terraform/ \
          --framework terraform \
          --output cli \
          --output json \
          --output sarif \
          --output-file-path checkov-report \
          --soft-fail \
          --compact
        
        # Parse results and set outputs
        if [ -f "checkov-report.json" ]; then
          CRITICAL=$(jq -r '.results.failed_checks | map(select(.severity == "CRITICAL")) | length' checkov-report.json 2>/dev/null || echo "0")
          HIGH=$(jq -r '.results.failed_checks | map(select(.severity == "HIGH")) | length' checkov-report.json 2>/dev/null || echo "0")
          MEDIUM=$(jq -r '.results.failed_checks | map(select(.severity == "MEDIUM")) | length' checkov-report.json 2>/dev/null || echo "0")
          LOW=$(jq -r '.results.failed_checks | map(select(.severity == "LOW")) | length' checkov-report.json 2>/dev/null || echo "0")
          PASSED=$(jq -r '.results.passed_checks | length' checkov-report.json 2>/dev/null || echo "0")
          
          echo "critical-issues=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high-issues=$HIGH" >> $GITHUB_OUTPUT
          echo "medium-issues=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low-issues=$LOW" >> $GITHUB_OUTPUT
          echo "passed-checks=$PASSED" >> $GITHUB_OUTPUT
          
          # Determine if security scan passed (no critical/high issues)
          if [ "$CRITICAL" -eq 0 ] && [ "$HIGH" -eq 0 ]; then
            echo "security-passed=true" >> $GITHUB_OUTPUT
            echo "Security scan passed - No critical or high severity issues"
          else
            echo "security-passed=false" >> $GITHUB_OUTPUT
            echo "Security scan failed - Found $CRITICAL critical and $HIGH high severity issues"
          fi
        else
          echo "security-passed=false" >> $GITHUB_OUTPUT
          echo "Could not parse Checkov results"
        fi

    - name: Upload Checkov Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: checkov-security-report
        path: |
          checkov-report.json
          checkov-report.sarif
        retention-days: 30

    - name: Security Summary
      run: |
        echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Critical | ${{ steps.checkov.outputs.critical-issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| High | ${{ steps.checkov.outputs.high-issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Medium | ${{ steps.checkov.outputs.medium-issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Low | ${{ steps.checkov.outputs.low-issues }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Passed | ${{ steps.checkov.outputs.passed-checks }} |" >> $GITHUB_STEP_SUMMARY

  terraform-plan-apply:
    name: 'Terraform Infrastructure'
    runs-on: ubuntu-latest
    needs: checkov-security-scan
    if: |
      (needs.checkov-security-scan.result == 'success' && github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch')
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    defaults:
      run:
        shell: bash
        working-directory: ./terraform

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform Backend
      working-directory: .
      run: |
        echo "Setting up Terraform backend..."
        
        # Bucket name is fixed in main.tf
        BUCKET_NAME="nt548-tfstate-409964509537"
        
        echo "Bucket name: ${BUCKET_NAME}"
        
        # Check and create S3 bucket if not exists
        if ! aws s3api head-bucket --bucket ${BUCKET_NAME} 2>/dev/null; then
          echo "S3 bucket does not exist, creating..."
          aws s3api create-bucket --bucket ${BUCKET_NAME} --region ${{ env.AWS_REGION }}
          
          # Enable versioning
          aws s3api put-bucket-versioning --bucket ${BUCKET_NAME} --versioning-configuration Status=Enabled
          
          # Enable encryption
          aws s3api put-bucket-encryption --bucket ${BUCKET_NAME} --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
          
          # Block public access
          aws s3api put-public-access-block --bucket ${BUCKET_NAME} --public-access-block-configuration '{"BlockPublicAcls":true,"IgnorePublicAcls":true,"BlockPublicPolicy":true,"RestrictPublicBuckets":true}'
          
          echo "S3 bucket created successfully"
        else
          echo "S3 bucket already exists"
        fi
        
        # Set lifecycle rule to delete old versions after 7 days
        echo "Setting lifecycle rule to delete old versions after 7 days..."
        aws s3api put-bucket-lifecycle-configuration \
          --bucket ${BUCKET_NAME} \
          --lifecycle-configuration '{
            "Rules": [
              {
                "Id": "DeleteOldVersions",
                "Status": "Enabled",
                "NoncurrentVersionExpiration": {
                  "NoncurrentDays": 7
                }
              }
            ]
          }' || echo "Warning: Failed to set lifecycle rule"
        
        # Check and create DynamoDB table if not exists
        if ! aws dynamodb describe-table --table-name nt548-terraform-locks --region ${{ env.AWS_REGION }} 2>/dev/null; then
          echo "DynamoDB table does not exist, creating..."
          aws dynamodb create-table \
            --table-name nt548-terraform-locks \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region ${{ env.AWS_REGION }}
          aws dynamodb wait table-exists --table-name nt548-terraform-locks --region ${{ env.AWS_REGION }}
          echo "DynamoDB table created successfully"
        else
          echo "DynamoDB table already exists"
        fi
        
        echo "Backend setup complete"

    - name: Terraform Format Check
      run: |
        echo "Checking Terraform formatting..."
        terraform fmt -recursive
        echo "Terraform formatting completed"

    - name: Terraform Initialize
      run: |
        echo "Initializing Terraform with S3 backend..."
        terraform init -input=false
        echo "Terraform initialized successfully"

    - name: Terraform Validate
      run: |
        echo "Validating Terraform configuration..."
        terraform validate
        echo "Terraform configuration is valid"

    - name: Terraform Plan
      id: plan
      env:
        TF_VAR_allowed_ssh_ip: ${{ secrets.TF_VAR_allowed_ssh_ip }}
        TF_VAR_key_pair_name: ${{ secrets.TF_VAR_key_pair_name }}
      run: |
        echo "Creating Terraform execution plan..."
        terraform plan -input=false -no-color -out=tfplan
        
        # Show plan in readable format
        echo "plan-output<<EOF" >> $GITHUB_OUTPUT
        terraform show -no-color tfplan >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "Terraform plan completed"

    - name: Terraform Apply
      if: |
        (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
      env:
        TF_VAR_allowed_ssh_ip: ${{ secrets.TF_VAR_allowed_ssh_ip }}
        TF_VAR_key_pair_name: ${{ secrets.TF_VAR_key_pair_name }}
      run: |
        echo "Applying Terraform changes..."
        terraform apply -auto-approve tfplan
        echo "Infrastructure deployed successfully"

    - name: Terraform Destroy
      if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'destroy' || github.event.inputs.action == 'destroy-all' || github.event.inputs.action == 'destroy-everything')
      env:
        TF_VAR_allowed_ssh_ip: ${{ secrets.TF_VAR_allowed_ssh_ip }}
        TF_VAR_key_pair_name: ${{ secrets.TF_VAR_key_pair_name }}
      run: |
        echo "Destroying Terraform infrastructure..."
        terraform destroy -auto-approve
        echo "Infrastructure destroyed successfully"
    
    - name: Remove DynamoDB Lock Entry
      if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'destroy' || github.event.inputs.action == 'destroy-all' || github.event.inputs.action == 'destroy-everything')
      working-directory: .
      run: |
        echo "Removing DynamoDB lock entry..."
        
        # Bucket name is fixed
        BUCKET_NAME="nt548-tfstate-409964509537"
        LOCK_ID="${BUCKET_NAME}/terraform.tfstate"
        
        # Try to delete lock entry (may not exist)
        aws dynamodb delete-item \
          --table-name nt548-terraform-locks \
          --key "{\"LockID\":{\"S\":\"${LOCK_ID}\"}}" \
          --region ${{ env.AWS_REGION }} || echo "No lock entry to remove"

    - name: Cleanup Terraform Backend
      if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'destroy-all' || github.event.inputs.action == 'destroy-everything')
      working-directory: .
      run: |
        echo "Cleaning up Terraform backend resources..."
        
        # Bucket name is fixed
        BUCKET_NAME="nt548-tfstate-409964509537"
        
        # Empty and delete S3 bucket
        echo "Emptying S3 bucket..."
        aws s3 rm s3://${BUCKET_NAME} --recursive || true
        
        echo "Deleting S3 bucket..."
        aws s3api delete-bucket --bucket ${BUCKET_NAME} --region ${{ env.AWS_REGION }} || true
        
        echo "Backend cleanup complete"
    
    - name: Delete DynamoDB Table
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy-everything'
      working-directory: .
      run: |
        echo "Deleting DynamoDB table..."
        aws dynamodb delete-table --table-name nt548-terraform-locks --region ${{ env.AWS_REGION }} || true
        echo "DynamoDB table deletion initiated"

    - name: Save Terraform Outputs
      if: |
        (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
      run: |
        echo "Saving Terraform outputs..."
        terraform output -json > terraform-outputs.json
        echo "## Infrastructure Outputs" >> $GITHUB_STEP_SUMMARY
        echo '```json' >> $GITHUB_STEP_SUMMARY
        cat terraform-outputs.json >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Upload Terraform Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: terraform-artifacts
        path: |
          terraform/tfplan
          terraform/terraform-outputs.json
        retention-days: 30

  infrastructure-tests:
    name: 'Infrastructure Testing'
    runs-on: ubuntu-latest
    needs: terraform-plan-apply
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform for Tests
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Download Terraform Artifacts
      uses: actions/download-artifact@v4
      with:
        name: terraform-artifacts
        path: terraform/

    - name: Install PowerShell
      run: |
        wget -q https://github.com/PowerShell/PowerShell/releases/download/v7.3.8/powershell_7.3.8-1.deb_amd64.deb
        sudo dpkg -i powershell_7.3.8-1.deb_amd64.deb
        sudo apt-get install -f

    - name: Initialize Terraform for Testing
      working-directory: ./terraform
      run: |
        echo "Initializing Terraform with S3 backend..."
        terraform init -input=false

    - name: Run Infrastructure Tests
      working-directory: ./tests
      run: |
        echo "Running infrastructure validation tests..."
        pwsh -File run-tests.ps1
        echo "All infrastructure tests passed"

    - name: Run Connectivity Tests
      working-directory: ./tests
      run: |
        echo "Running connectivity tests..."
        pwsh -File test-connectivity.ps1
        echo "Connectivity tests completed"

  verify-destroy:
    name: 'Verify Infrastructure Destroyed'
    runs-on: ubuntu-latest
    needs: terraform-plan-apply
    if: github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'destroy' || github.event.inputs.action == 'destroy-all' || github.event.inputs.action == 'destroy-everything')
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Verify No NT548 Resources Exist
      run: |
        echo "Verifying all NT548 infrastructure has been destroyed..."
        
        # Check for VPCs
        VPC_COUNT=$(aws ec2 describe-vpcs --filters "Name=tag:Project,Values=NT548*" --query 'length(Vpcs)' --output text)
        echo "VPCs found: $VPC_COUNT"
        
        # Check for EC2 instances
        EC2_COUNT=$(aws ec2 describe-instances --filters "Name=tag:Project,Values=NT548*" "Name=instance-state-name,Values=running,stopped,stopping,pending" --query 'length(Reservations[].Instances[])' --output text)
        echo "EC2 instances found: $EC2_COUNT"
        
        # Check for NAT Gateways
        NAT_COUNT=$(aws ec2 describe-nat-gateways --filter "Name=tag:Project,Values=NT548*" "Name=state,Values=available,pending" --query 'length(NatGateways)' --output text)
        echo "NAT Gateways found: $NAT_COUNT"
        
        # Check for Elastic IPs
        EIP_COUNT=$(aws ec2 describe-addresses --filters "Name=tag:Project,Values=NT548*" --query 'length(Addresses)' --output text)
        echo "Elastic IPs found: $EIP_COUNT"
        
        # Summary
        TOTAL=$((VPC_COUNT + EC2_COUNT + NAT_COUNT + EIP_COUNT))
        
        echo ""
        echo "=== Destroy Verification Summary ==="
        if [ "$TOTAL" -eq 0 ]; then
          echo "SUCCESS: All NT548 infrastructure has been destroyed"
          echo "No resources found in AWS"
        else
          echo "FAILED: $TOTAL resources still exist"
          echo "VPCs: $VPC_COUNT"
          echo "EC2: $EC2_COUNT"
          echo "NAT Gateways: $NAT_COUNT"
          echo "Elastic IPs: $EIP_COUNT"
          exit 1
        fi

    - name: Verify Backend Cleanup
      if: github.event.inputs.action == 'destroy-all' || github.event.inputs.action == 'destroy-everything'
      run: |
        echo "Verifying backend resources cleanup..."
        
        # Bucket name is fixed
        BUCKET_NAME="nt548-tfstate-409964509537"
        
        # Check S3 bucket
        if aws s3api head-bucket --bucket ${BUCKET_NAME} 2>/dev/null; then
          echo "WARNING: S3 bucket still exists"
          S3_EXISTS=1
        else
          echo "S3 bucket deleted successfully"
          S3_EXISTS=0
        fi
        
        # Check DynamoDB table (only for destroy-everything)
        if [ "${{ github.event.inputs.action }}" == "destroy-everything" ]; then
          if aws dynamodb describe-table --table-name nt548-terraform-locks --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "WARNING: DynamoDB table still exists (may be deleting)"
            DYNAMO_EXISTS=1
          else
            echo "DynamoDB table deleted successfully"
            DYNAMO_EXISTS=0
          fi
        fi
        
        # Check DynamoDB table
        if aws dynamodb describe-table --table-name nt548-terraform-locks --region ${{ env.AWS_REGION }} 2>/dev/null; then
          echo "WARNING: DynamoDB table still exists (may be deleting)"
          DYNAMO_EXISTS=1
        else
          echo "DynamoDB table deleted successfully"
          DYNAMO_EXISTS=0
        fi
        
        echo ""
        echo "=== Backend Cleanup Summary ==="
        if [ "$S3_EXISTS" -eq 0 ] && [ "$DYNAMO_EXISTS" -eq 0 ]; then
          echo "SUCCESS: All backend resources cleaned up"
        else
          echo "Some backend resources may still be deleting (this is normal)"
        fi

  deployment-notification:
    name: 'Deployment Notification'
    runs-on: ubuntu-latest
    needs: [checkov-security-scan, terraform-plan-apply, infrastructure-tests, verify-destroy]
    if: always()
    
    steps:
    - name: Deployment Success Notification
      if: |
        needs.checkov-security-scan.result == 'success' &&
        needs.terraform-plan-apply.result == 'success' &&
        (needs.infrastructure-tests.result == 'success' || needs.infrastructure-tests.result == 'skipped')
      run: |
        echo "## NT548 Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Security Scan**: Passed" >> $GITHUB_STEP_SUMMARY
        echo "**Infrastructure**: Deployed" >> $GITHUB_STEP_SUMMARY
        echo "**Tests**: Passed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your AWS infrastructure is ready!" >> $GITHUB_STEP_SUMMARY

    - name: Destroy Success Notification
      if: |
        needs.terraform-plan-apply.result == 'success' &&
        needs.verify-destroy.result == 'success'
      run: |
        echo "## NT548 Infrastructure Destroyed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Terraform Destroy**: Success" >> $GITHUB_STEP_SUMMARY
        echo "**Verification**: All resources removed" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.action }}" == "destroy-all" ]; then
          echo "**Backend Cleanup**: S3 and DynamoDB removed" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "AWS infrastructure has been completely destroyed!" >> $GITHUB_STEP_SUMMARY

    - name: Deployment Failure Notification
      if: |
        needs.checkov-security-scan.result == 'failure' ||
        needs.terraform-plan-apply.result == 'failure' ||
        needs.infrastructure-tests.result == 'failure' ||
        needs.verify-destroy.result == 'failure'
      run: |
        echo "## NT548 Workflow Failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Security Scan**: ${{ needs.checkov-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Infrastructure**: ${{ needs.terraform-plan-apply.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Tests**: ${{ needs.infrastructure-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Destroy Verification**: ${{ needs.verify-destroy.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Please check the logs and fix the issues." >> $GITHUB_STEP_SUMMARY
        exit 1